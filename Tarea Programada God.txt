USE tu_base_de_datos; -- Reemplaza "tu_base_de_datos" con el nombre de tu base de datos

-- Crear la tarea programada
IF EXISTS (SELECT * FROM sysjobs WHERE name = 'TareaProgramadaReservaciones')
    EXEC msdb.dbo.sp_delete_job @job_name = 'TareaProgramadaReservaciones';

EXEC msdb.dbo.sp_add_job
     @job_name = 'TareaProgramadaReservaciones',
     @enabled = 1,
     @description = 'Tarea programada para verificar y actualizar las reservaciones diariamente';

-- Configurar el paso de la tarea programada
EXEC msdb.dbo.sp_add_jobstep
     @job_name = 'TareaProgramadaReservaciones',
     @step_name = 'Verificar y actualizar reservaciones',
     @subsystem = 'TSQL',
     @command = '
        IF EXISTS (
            SELECT 1
            FROM Acti.tbReservaciones r
            INNER JOIN Acti.tbActividadesXFecha af ON r.acti_Id = af.acti_Id AND r.rese_FechaReservacion = af.acfe_Fecha
            INNER JOIN Acti.tbEquipoXActividades ea ON af.acti_Id = ea.acti_Id
            INNER JOIN Acti.tbEquipos e ON ea.equi_Id = e.equi_Id
            WHERE r.rese_FechaReservacion = CONVERT(date, GETDATE())
        )
        BEGIN
            UPDATE e
            SET equi_UsoActual = equi_UsoActual + 1
            FROM Acti.tbReservaciones r
            INNER JOIN Acti.tbActividadesXFecha af ON r.acti_Id = af.acti_Id AND r.rese_FechaReservacion = af.acfe_Fecha
            INNER JOIN Acti.tbEquipoXActividades ea ON af.acti_Id = ea.acti_Id
            INNER JOIN Acti.tbEquipos e ON ea.equi_Id = e.equi_Id
            WHERE r.rese_FechaReservacion = CONVERT(date, GETDATE())
        END',
     @database_name = 'tu_base_de_datos', -- Reemplaza "tu_base_de_datos" con el nombre de tu base de datos
     @on_success_action = 1;

-- Configurar la programación de la tarea
EXEC msdb.dbo.sp_add_schedule
     @schedule_name = 'TareaProgramadaReservaciones_Schedule',
     @enabled = 1,
     @freq_type = 4,
     @freq_interval = 1,
     @freq_subday_type = 1,
     @freq_subday_interval = 0,
     @freq_recurrence_factor = 1,
     @active_start_date = 20230531,
     @active_end_date = 99991231,
     @active_start_time = 000000,
     @active_end_time = 235959;

-- Asociar la programación a la tarea
EXEC msdb.dbo.sp_attach_schedule
     @job_name = 'TareaProgramadaReservaciones',
     @schedule_name = 'TareaProgramadaReservaciones_Schedule';

-- Iniciar la tarea
EXEC msdb.dbo.sp_start_job @job_name = 'TareaProgramadaReservaciones';
